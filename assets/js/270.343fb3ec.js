(window.webpackJsonp=window.webpackJsonp||[]).push([[270],{647:function(s,t,a){"use strict";a.r(t);var e=a(4),n=Object(e.a)({},(function(){var s=this,t=s._self._c;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("h1",{attrs:{id:"sql-语句优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#sql-语句优化"}},[s._v("#")]),s._v(" SQL 语句优化")]),s._v(" "),t("h2",{attrs:{id:"日期比较"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#日期比较"}},[s._v("#")]),s._v(" 日期比较")]),s._v(" "),t("p",[t("strong",[s._v("日期比较：")]),s._v(" 将 "),t("code",[s._v("DATEDIFF")]),s._v(" 改为使用 "),t("code",[s._v("CURDATE()")]),s._v("，并将条件修改为 "),t("code",[s._v("expire_date <= CURDATE() + INTERVAL 30 DAY")]),s._v("，这样可以避免在每一行上执行函数。")]),s._v(" "),t("h3",{attrs:{id:"修改前"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改前"}},[s._v("#")]),s._v(" 修改前")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" DATEDIFF"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" expire_date"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("NOW")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h3",{attrs:{id:"修改后"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#修改后"}},[s._v("#")]),s._v(" 修改后")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v("expire_date "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("<=")]),s._v(" CURDATE"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("+")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("INTERVAL")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("30")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DAY")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("h2",{attrs:{id:"多个-left-join-同一张表优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#多个-left-join-同一张表优化"}},[s._v("#")]),s._v(" 多个 left join 同一张表优化")]),s._v(" "),t("h3",{attrs:{id:"原代码"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#原代码"}},[s._v("#")]),s._v(" 原代码")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("select")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("f0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("f1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path file1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        f2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path file2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("f3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path file3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("f4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path file4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n        f5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_path file5\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("from")]),s._v(" \n        \tsafe\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f0 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f0"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f1 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f2 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f3 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v("\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f4 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v("\n        \t"),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("left")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("join")]),s._v(" tbl_file f5 "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("on")]),s._v(" f5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("and")]),s._v(" f5"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_deleted "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" \n        \tsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DESC")]),s._v(" \n          "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br")])]),t("p",[t("strong",[s._v("运行报错：")])]),s._v(" "),t("div",{staticClass:"language- line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-text"}},[t("code",[s._v("Can't create/write to file '/tmp/MYfEfAaN' (OS errno 24 - Too many open files)\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br")])]),t("p",[s._v('这错误表明在执行 SQL 查询时，MySQL 打开的文件句柄数达到系统限制，导致无法再打开新的文件。错误信息中的 "/tmp/MYfEfAaN" 是 MySQL 试图创建或写入的文件路径。')]),s._v(" "),t("p",[s._v("这个问题通常是由系统的文件句柄限制引起的。每个打开的文件都需要一个文件句柄，而系统默认对于一个进程能够同时打开的文件数量有一个限制。在这种情况下，MySQL 打开了太多的文件，超过了系统允许的限制。")]),s._v(" "),t("h3",{attrs:{id:"子查询修改"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#子查询修改"}},[s._v("#")]),s._v(" 子查询修改")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n            safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v(" tbl_file "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHERE")]),s._v(" obj_id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("AND")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file5\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n            safe\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_deleted "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" \n        \tsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DESC")]),s._v(" \n          "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br")])]),t("p",[t("strong",[s._v("运行时间：15s 左右，性能太差！！！")])]),s._v(" "),t("p",[t("strong",[s._v("注意：")])]),s._v(" "),t("p",[s._v("LIMIT 1 的作用是：限制查询结果返回的行数，只返回一条记录。在第一条 SQL 查询中，每个文件类别都使用了 LIMIT 1 来确保只选择一条与之关联的文件路径。这样做的目的是为了避免在选择多个文件路径时出现重复的情况，因为 tbl_file 表中可能存在多条与同一个 obj_id 关联的文件记录。通过使用 LIMIT 1，可以确保每个文件类别只选择一条记录，从而避免重复。")]),s._v(" "),t("blockquote",[t("p",[s._v("根据实际情况使用，如果一定不会重复，可不写。")])]),s._v(" "),t("h3",{attrs:{id:"条件表达式优化-最终版"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#条件表达式优化-最终版"}},[s._v("#")]),s._v(" 条件表达式优化（最终版）")]),s._v(" "),t("div",{staticClass:"language-sql line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-sql"}},[t("code",[s._v("        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("SELECT")]),s._v("\n            safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("*")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("file")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file1"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file2"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file3"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("4")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file4"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(",")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("MAX")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("CASE")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("WHEN")]),s._v(" file_class "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("5")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("THEN")]),s._v(" file_path "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("END")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("AS")]),s._v(" file5\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("FROM")]),s._v("\n            safe\n            "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LEFT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("JOIN")]),s._v(" tbl_file f "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ON")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" f"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("obj_id\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("where")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("is_deleted "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("0")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("GROUP")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" safe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("id\n        "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("ORDER")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("BY")]),s._v(" \n        \tsafe"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("create_time "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("DESC")]),s._v(" \n          "),t("span",{pre:!0,attrs:{class:"token keyword"}},[s._v("LIMIT")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("20")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(";")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br")])]),t("p",[t("strong",[s._v("运行时间：900ms 左右，性能不错！！！")])]),s._v(" "),t("p",[s._v("这个优化的逻辑主要通过使用 "),t("code",[s._v("LEFT JOIN")]),s._v(" 连接 "),t("code",[s._v("safe")]),s._v(" 表和 "),t("code",[s._v("tbl_file")]),s._v(" 表，然后使用聚合函数 "),t("code",[s._v("MAX")]),s._v(" 结合 "),t("code",[s._v("CASE")]),s._v(" 表达式来获取每个 "),t("code",[s._v("file_class")]),s._v(" 对应的文件路径。")]),s._v(" "),t("p",[s._v("下面逐步解释优化的逻辑：")]),s._v(" "),t("ol",[t("li",[t("strong",[s._v("左连接 ("),t("code",[s._v("LEFT JOIN")]),s._v(")：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("LEFT JOIN")]),s._v(" 用于连接 "),t("code",[s._v("safe")]),s._v(" 表和 "),t("code",[s._v("tbl_file")]),s._v(" 表，即使在没有匹配的情况下也会保留左表中的所有行。")]),s._v(" "),t("li",[s._v("这确保了即使某个 "),t("code",[s._v("safe")]),s._v(" 行没有对应的文件记录，也会在结果中保留。")])])]),s._v(" "),t("li",[t("strong",[s._v("聚合函数 "),t("code",[s._v("MAX")]),s._v("：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("MAX")]),s._v(" 函数用于获取每个 "),t("code",[s._v("file_class")]),s._v(" 对应的最大文件路径。在这里，实际上是获取了每个 "),t("code",[s._v("file_class")]),s._v(" 对应的唯一文件路径（因为 "),t("code",[s._v("MAX")]),s._v(" 函数作用于单个值的集合）。")])])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("CASE")]),s._v(" 表达式：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("CASE")]),s._v(" 表达式用于在每个 "),t("code",[s._v("MAX")]),s._v(" 函数中选择正确的文件路径。对于每个 "),t("code",[s._v("file_class")]),s._v("，"),t("code",[s._v("CASE")]),s._v(" 表达式返回对应的 "),t("code",[s._v("file_path")]),s._v(" 值。")])])]),s._v(" "),t("li",[t("strong",[t("code",[s._v("GROUP BY")]),s._v(" 子句：")]),s._v(" "),t("ul",[t("li",[t("code",[s._v("GROUP BY")]),s._v(" 子句用于按照 "),t("code",[s._v("safe")]),s._v(" 表中的 "),t("code",[s._v("id")]),s._v(" 分组，确保每个 "),t("code",[s._v("safe")]),s._v(" 行只有一行结果。")]),s._v(" "),t("li",[s._v("在每个分组中，"),t("code",[s._v("MAX")]),s._v(" 函数将获取每个 "),t("code",[s._v("file_class")]),s._v(" 对应的最大文件路径。")])])])]),s._v(" "),t("p",[s._v("这种优化的主要思想是将多个子查询合并成一个联接查询，以减少对数据库的多次扫描。同时，使用聚合函数将每个 "),t("code",[s._v("file_class")]),s._v(" 对应的多个文件路径合并为一个结果行，使得结果更加简洁。")]),s._v(" "),t("h3",{attrs:{id:"执行计划对比"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#执行计划对比"}},[s._v("#")]),s._v(" 执行计划对比")]),s._v(" "),t("h4",{attrs:{id:"_1、子查询版"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_1、子查询版"}},[s._v("#")]),s._v(" 1、子查询版")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"image","data-src":"https://cmty256.github.io/imgs-blog/MySQL/image.1mv26jtmiacg.webp",loading:"lazy"}})]),s._v(" "),t("h4",{attrs:{id:"_2、条件表达式优化版"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#_2、条件表达式优化版"}},[s._v("#")]),s._v(" 2、条件表达式优化版")]),s._v(" "),t("p",[t("img",{staticClass:"lazy",attrs:{alt:"image","data-src":"https://cmty256.github.io/imgs-blog/MySQL/image.7gu8nx05xgk0.webp",loading:"lazy"}})]),s._v(" "),t("h2",{attrs:{id:"分页优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#分页优化"}},[s._v("#")]),s._v(" 分页优化")]),s._v(" "),t("p",[s._v("分页优化的常用技巧包括：")]),s._v(" "),t("ol",[t("li",[s._v("使用覆盖索引：如果一条 SQL 语句可以通过索引直接获取查询的结果，不再需要回表查询，这个索引就称为覆盖索引。覆盖索引可以显著提高查询性能。")]),s._v(" "),t("li",[t("strong",[s._v("使用子查询优化")]),s._v("：这种方式先定位偏移位置的 id，然后往后查询，这种方式适用于 id 递增的情况。")]),s._v(" "),t("li",[s._v("使用 id 限定优化：这种方式假设数据表的 id 是连续递增的，则我们根据查询的页数和查询的记录数可以算出查询的 id 的范围，可以使用 id between and 来查询。")]),s._v(" "),t("li",[s._v("使用临时表优化：这种方式已经不属于查询优化，但是可以在处理大量数据时提高效率。")]),s._v(" "),t("li",[s._v("使用合适的索引：为了提高查询性能，可以使用适当的索引，如主键、唯一索引、联合索引等。")]),s._v(" "),t("li",[s._v("根据自增且连续的主键排序的分页查询：这种方式可以利用主键的连续性，通过计算偏移量来提高查询效率。")]),s._v(" "),t("li",[s._v("Join 关联查询优化：对于涉及到多表连接的查询，可以通过优化连接算法来提高查询性能。")])]),s._v(" "),t("p",[t("strong",[s._v("利用好 小表驱动大表 ！！！")])]),s._v(" "),t("p",[t("a",{attrs:{href:"https://blog.csdn.net/weixin_42028840/article/details/118266053",target:"_blank",rel:"noopener noreferrer"}},[s._v("Java性能调优--SQL篇：优化“分页查询“_java项目显示数据库中的数据时,涉及到了大数据量的查询和分页,怎么进行优化,使性-CSDN博客"),t("OutboundLink")],1)]),s._v(" "),t("p",[t("a",{attrs:{href:"https://www.cnblogs.com/fengli9998/p/11456829.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("数据量很大，分页查询很慢，优化方案 - 小虾米的java梦 - 博客园 (cnblogs.com)"),t("OutboundLink")],1)]),s._v(" "),t("h2",{attrs:{id:"not-exist-子查询优化"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#not-exist-子查询优化"}},[s._v("#")]),s._v(" not exist 子查询优化")]),s._v(" "),t("p",[s._v("可用 join + where 子句替代来优化性能")])])}),[],!1,null,null,null);t.default=n.exports}}]);